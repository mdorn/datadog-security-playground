#!/bin/bash
# Build script for malware simulator binaries
# This script compiles the Go-based malware simulator for x64 and ARM64

set -e  # Exit on error
set -u  # Exit on undefined variable

# Configuration
SOURCE_FILE="main.go"
BINARY_X64="malware.x64"
BINARY_ARM64="malware.arm64"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "==================================="
echo "Building Malware Simulator"
echo "==================================="

# Check if source file exists
if [ ! -f "$SOURCE_FILE" ]; then
    echo -e "${RED}Error: Source file $SOURCE_FILE not found${NC}"
    exit 1
fi

# Display build info
echo "Source: $SOURCE_FILE"
echo "Targets: $BINARY_X64, $BINARY_ARM64"
echo "Go version: $(go version)"
echo ""

# Build x64 binary
echo "Building x64 binary..."
GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-extldflags=-static" -o "$BINARY_X64" "$SOURCE_FILE"

if [ -f "$BINARY_X64" ]; then
    echo -e "${GREEN}✓ x64 build successful!${NC}"
    ls -lh "$BINARY_X64"
else
    echo -e "${RED}✗ x64 build failed!${NC}"
    exit 1
fi

echo ""

# Build ARM64 binary
echo "Building ARM64 binary..."
GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-extldflags=-static" -o "$BINARY_ARM64" "$SOURCE_FILE"

if [ -f "$BINARY_ARM64" ]; then
    echo -e "${GREEN}✓ ARM64 build successful!${NC}"
    ls -lh "$BINARY_ARM64"
else
    echo -e "${RED}✗ ARM64 build failed!${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}All builds completed successfully!${NC}"

# Display binary information
echo ""
echo "Binary information:"
file "$BINARY_X64" || true
file "$BINARY_ARM64" || true
